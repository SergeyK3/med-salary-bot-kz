# ------------------------------------------------------------
# База: небольшой образ, где есть glibc и колёса для pandas/numpy
# ------------------------------------------------------------
FROM python:3.12-slim AS runtime

# Больше предсказуемости и логов
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Версия/коммит — попадут в /version (можно переопределять при сборке)
ARG APP_VERSION=dev
ARG GIT_SHA=unknown
ENV APP_VERSION=${APP_VERSION} \
    GIT_SHA=${GIT_SHA}

# Рабочая директория
WORKDIR /app

# ------------------------------------------------------------
# 1) Ставим зависимости отдельно (идеально кэшируется)
# ------------------------------------------------------------
# Если нужны системные пакеты (например, curl для HEALTHCHECK) — раскомментируй
# RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ------------------------------------------------------------
# 2) Кладём весь проект
# ------------------------------------------------------------
COPY . .

# ------------------------------------------------------------
# 3) Безопасность: не root
# ------------------------------------------------------------
# UID/GID можно поменять при желании
RUN addgroup --system app && adduser --system --ingroup app --home /app app
USER app:app

# ------------------------------------------------------------
# 4) Порт и команда запуска
# ------------------------------------------------------------
EXPOSE 8000

# Для PaaS-хостингов порт часто приходит через $PORT.
# Оставляем одну универсальную CMD: локально будет 8000,
# на проде подставится $PORT, если платформа его выставит.
CMD ["sh", "-c", "uvicorn src.api:app --host 0.0.0.0 --port ${PORT:-8000}"]
# Для продовой нагрузки можно добавить воркеры:
# CMD ["sh", "-c", "uvicorn src.api:app --host 0.0.0.0 --port ${PORT:-8000} --workers ${WEB_CONCURRENCY:-1}"]

# ------------------------------------------------------------
# 5) (Опционально) HEALTHCHECK. Потребуется curl или аналог.
# ------------------------------------------------------------
# HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
#   CMD curl -fsS http://127.0.0.1:${PORT:-8000}/healthz || exit 1
